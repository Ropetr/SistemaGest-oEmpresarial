<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Basico - Sistema de Gestao Empresarial</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        h1 { color: #667eea; font-size: 2.2em; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 1.1em; }
        .status-bar { text-align: center; padding: 12px; background: #d4edda; color: #155724; border-radius: 10px; margin-bottom: 20px; font-weight: bold; }
        .status-bar.error { background: #f8d7da; color: #721c24; }
        .nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
        .nav button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 600; background: white; color: #667eea; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; }
        .nav button:hover, .nav button.active { background: #667eea; color: white; transform: translateY(-2px); }
        .panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .panel.active { display: block; }
        .panel h2 { color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #555; margin-bottom: 4px; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; }
        .form-group textarea { min-height: 60px; resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-sm { padding: 5px 12px; font-size: 0.8em; }
        .actions { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; }
        th { background: #f8f9fa; font-weight: 600; color: #555; position: sticky; top: 0; }
        tr:hover { background: #f0f4ff; }
        .badge { padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
        .badge-ok { background: #d4edda; color: #155724; }
        .badge-warn { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { padding: 20px; border-radius: 10px; color: white; text-align: center; }
        .card h3 { font-size: 1.6em; margin-bottom: 5px; }
        .card p { opacity: 0.9; }
        .card-blue { background: linear-gradient(135deg, #667eea, #764ba2); }
        .card-green { background: linear-gradient(135deg, #28a745, #20c997); }
        .card-red { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        .card-yellow { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 10px; padding: 25px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; }
        .modal h3 { color: #667eea; margin-bottom: 15px; }
        .items-list { margin: 15px 0; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: end; }
        .item-row select, .item-row input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; }
        .table-responsive { overflow-x: auto; }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .item-row { grid-template-columns: 1fr 1fr; }
            h1 { font-size: 1.5em; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ERP Basico - Gestao Empresarial</h1>
        <p class="subtitle">Sistema completo na Cloudflare</p>
    </header>
    <div id="statusBar" class="status-bar">Verificando conexao...</div>
    <div class="nav">
        <button onclick="showPanel('dashboard')" class="active" id="btn-dashboard">Dashboard</button>
        <button onclick="showPanel('clientes')" id="btn-clientes">Clientes</button>
        <button onclick="showPanel('fornecedores')" id="btn-fornecedores">Fornecedores</button>
        <button onclick="showPanel('produtos')" id="btn-produtos">Produtos</button>
        <button onclick="showPanel('orcamentos')" id="btn-orcamentos">Orcamentos</button>
        <button onclick="showPanel('pedidos')" id="btn-pedidos">Pedidos Venda</button>
        <button onclick="showPanel('notas-entrada')" id="btn-notas-entrada">Notas Entrada</button>
        <button onclick="showPanel('notas-saida')" id="btn-notas-saida">Notas Saida</button>
        <button onclick="showPanel('estoque')" id="btn-estoque">Estoque</button>
        <button onclick="showPanel('financeiro')" id="btn-financeiro">Financeiro</button>
    </div>

    <!-- Dashboard -->
    <div class="panel active" id="panel-dashboard">
        <h2>Dashboard</h2>
        <div class="summary-cards" id="dashboardCards"></div>
        <h3 style="margin:15px 0 10px">Posicao de Estoque</h3>
        <div class="table-responsive"><table><thead><tr><th>Codigo</th><th>Produto</th><th>Estoque Atual</th><th>Estoque Minimo</th><th>Status</th></tr></thead><tbody id="dashEstoque"></tbody></table></div>
    </div>

    <!-- Clientes -->
    <div class="panel" id="panel-clientes">
        <h2>Clientes</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openForm('clientes')">+ Novo Cliente</button></div>
        <div class="table-responsive"><table><thead><tr><th>ID</th><th>Nome</th><th>CPF/CNPJ</th><th>Email</th><th>Telefone</th><th>Cidade/UF</th><th>Acoes</th></tr></thead><tbody id="tblClientes"></tbody></table></div>
    </div>

    <!-- Fornecedores -->
    <div class="panel" id="panel-fornecedores">
        <h2>Fornecedores</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openForm('fornecedores')">+ Novo Fornecedor</button></div>
        <div class="table-responsive"><table><thead><tr><th>ID</th><th>Nome</th><th>CNPJ</th><th>Email</th><th>Telefone</th><th>Cidade/UF</th><th>Acoes</th></tr></thead><tbody id="tblFornecedores"></tbody></table></div>
    </div>

    <!-- Produtos -->
    <div class="panel" id="panel-produtos">
        <h2>Produtos</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openForm('produtos')">+ Novo Produto</button></div>
        <div class="table-responsive"><table><thead><tr><th>Codigo</th><th>Nome</th><th>Unid</th><th>Custo</th><th>Venda</th><th>Estoque</th><th>Acoes</th></tr></thead><tbody id="tblProdutos"></tbody></table></div>
    </div>

    <!-- Orcamentos -->
    <div class="panel" id="panel-orcamentos">
        <h2>Orcamentos</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openOrcamentoForm()">+ Novo Orcamento</button></div>
        <div class="table-responsive"><table><thead><tr><th>Numero</th><th>Cliente</th><th>Data</th><th>Valor Total</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="tblOrcamentos"></tbody></table></div>
    </div>

    <!-- Pedidos Venda -->
    <div class="panel" id="panel-pedidos">
        <h2>Pedidos de Venda</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openPedidoForm()">+ Novo Pedido</button></div>
        <div class="table-responsive"><table><thead><tr><th>Numero</th><th>Cliente</th><th>Data</th><th>Valor Total</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="tblPedidos"></tbody></table></div>
    </div>

    <!-- Notas Entrada -->
    <div class="panel" id="panel-notas-entrada">
        <h2>Notas de Entrada</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openNotaEntradaForm()">+ Nova Nota Entrada</button></div>
        <div class="table-responsive"><table><thead><tr><th>Numero</th><th>Fornecedor</th><th>Data</th><th>Valor Total</th><th>Acoes</th></tr></thead><tbody id="tblNotasEntrada"></tbody></table></div>
    </div>

    <!-- Notas Saida -->
    <div class="panel" id="panel-notas-saida">
        <h2>Notas de Saida</h2>
        <div class="actions"><button class="btn btn-primary" onclick="openNotaSaidaForm()">+ Nova Nota Saida</button></div>
        <div class="table-responsive"><table><thead><tr><th>Numero</th><th>Cliente</th><th>Data</th><th>Valor Total</th><th>Acoes</th></tr></thead><tbody id="tblNotasSaida"></tbody></table></div>
    </div>

    <!-- Estoque -->
    <div class="panel" id="panel-estoque">
        <h2>Estoque</h2>
        <div class="table-responsive"><table><thead><tr><th>Codigo</th><th>Produto</th><th>Unidade</th><th>Estoque Atual</th><th>Estoque Minimo</th><th>Status</th></tr></thead><tbody id="tblEstoque"></tbody></table></div>
        <h3 style="margin:20px 0 10px">Movimentacoes Recentes</h3>
        <div class="table-responsive"><table><thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Anterior</th><th>Atual</th><th>Referencia</th></tr></thead><tbody id="tblMovimentos"></tbody></table></div>
    </div>

    <!-- Financeiro -->
    <div class="panel" id="panel-financeiro">
        <h2>Financeiro</h2>
        <div class="summary-cards" id="finCards"></div>
        <div class="actions">
            <button class="btn btn-primary" onclick="openLancamentoForm()">+ Novo Lancamento</button>
            <button class="btn btn-success" onclick="loadFinanceiro()">Atualizar</button>
        </div>
        <div class="table-responsive"><table><thead><tr><th>ID</th><th>Tipo</th><th>Descricao</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="tblFinanceiro"></tbody></table></div>
    </div>
</div>

<!-- Modal generico -->
<div class="modal-overlay" id="modal">
    <div class="modal" id="modalContent"></div>
</div>

<script>
const API = '/api';

function showPanel(name) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-' + name).classList.add('active');
    document.getElementById('btn-' + name).classList.add('active');
    loadPanelData(name);
}

function loadPanelData(name) {
    const loaders = {
        dashboard: loadDashboard, clientes: loadClientes, fornecedores: loadFornecedores,
        produtos: loadProdutos, orcamentos: loadOrcamentos, pedidos: loadPedidos,
        'notas-entrada': loadNotasEntrada, 'notas-saida': loadNotasSaida,
        estoque: loadEstoque, financeiro: loadFinanceiro
    };
    if (loaders[name]) loaders[name]();
}

async function apiFetch(endpoint, opts = {}) {
    const res = await fetch(API + endpoint, {
        headers: { 'Content-Type': 'application/json' }, ...opts,
        body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if (res.status === 204) return null;
    return res.json();
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
}

function openModal(html) {
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modal').classList.add('active');
}

function fmt(v) { return (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
function fmtDate(d) { return d ? new Date(d).toLocaleDateString('pt-BR') : '-'; }

// ---- DASHBOARD ----
async function loadDashboard() {
    try {
        const [clientes, produtos, estoque, resumo] = await Promise.all([
            apiFetch('/clientes'), apiFetch('/produtos'), apiFetch('/estoque'), apiFetch('/financeiro/resumo')
        ]);
        document.getElementById('dashboardCards').innerHTML = `
            <div class="card card-blue"><h3>${clientes.length}</h3><p>Clientes Ativos</p></div>
            <div class="card card-green"><h3>${produtos.length}</h3><p>Produtos Ativos</p></div>
            <div class="card card-yellow"><h3>${fmt(resumo.receitas.total)}</h3><p>Receitas</p></div>
            <div class="card card-red"><h3>${fmt(resumo.despesas.total)}</h3><p>Despesas</p></div>
        `;
        document.getElementById('dashEstoque').innerHTML = estoque.map(e => `
            <tr><td>${e.codigo}</td><td>${e.nome}</td><td>${e.estoque_atual}</td><td>${e.estoque_minimo}</td>
            <td><span class="badge ${e.status === 'OK' ? 'badge-ok' : 'badge-danger'}">${e.status}</span></td></tr>
        `).join('');
        document.getElementById('statusBar').className = 'status-bar';
        document.getElementById('statusBar').textContent = 'Sistema Online e Funcionando - Cloudflare Workers + D1';
    } catch (e) {
        document.getElementById('statusBar').className = 'status-bar error';
        document.getElementById('statusBar').textContent = 'Erro de conexao: ' + e.message;
    }
}

// ---- CLIENTES ----
async function loadClientes() {
    const data = await apiFetch('/clientes');
    document.getElementById('tblClientes').innerHTML = data.map(c => `
        <tr><td>${c.id}</td><td>${c.nome}</td><td>${c.cpf_cnpj}</td><td>${c.email||'-'}</td><td>${c.telefone||'-'}</td>
        <td>${c.cidade||''}/${c.estado||''}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteItem('/clientes/${c.id}','clientes')">Excluir</button></td></tr>
    `).join('');
}

function openForm(type) {
    const forms = {
        clientes: `<h3>Novo Cliente</h3>
            <div class="form-grid">
                <div class="form-group"><label>Nome *</label><input id="f_nome"></div>
                <div class="form-group"><label>CPF/CNPJ *</label><input id="f_cpf_cnpj"></div>
                <div class="form-group"><label>Email</label><input id="f_email" type="email"></div>
                <div class="form-group"><label>Telefone</label><input id="f_telefone"></div>
                <div class="form-group"><label>Endereco</label><input id="f_endereco"></div>
                <div class="form-group"><label>Cidade</label><input id="f_cidade"></div>
                <div class="form-group"><label>Estado</label><input id="f_estado" maxlength="2"></div>
                <div class="form-group"><label>CEP</label><input id="f_cep"></div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="saveCliente()">Salvar</button>
                <button class="btn" onclick="closeModal()">Cancelar</button>
            </div>`,
        fornecedores: `<h3>Novo Fornecedor</h3>
            <div class="form-grid">
                <div class="form-group"><label>Nome *</label><input id="f_nome"></div>
                <div class="form-group"><label>CNPJ *</label><input id="f_cnpj"></div>
                <div class="form-group"><label>Email</label><input id="f_email" type="email"></div>
                <div class="form-group"><label>Telefone</label><input id="f_telefone"></div>
                <div class="form-group"><label>Endereco</label><input id="f_endereco"></div>
                <div class="form-group"><label>Cidade</label><input id="f_cidade"></div>
                <div class="form-group"><label>Estado</label><input id="f_estado" maxlength="2"></div>
                <div class="form-group"><label>CEP</label><input id="f_cep"></div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="saveFornecedor()">Salvar</button>
                <button class="btn" onclick="closeModal()">Cancelar</button>
            </div>`,
        produtos: `<h3>Novo Produto</h3>
            <div class="form-grid">
                <div class="form-group"><label>Codigo *</label><input id="f_codigo"></div>
                <div class="form-group"><label>Nome *</label><input id="f_nome"></div>
                <div class="form-group"><label>Descricao</label><input id="f_descricao"></div>
                <div class="form-group"><label>Unidade</label><input id="f_unidade" value="UN"></div>
                <div class="form-group"><label>Preco Custo</label><input id="f_preco_custo" type="number" step="0.01" value="0"></div>
                <div class="form-group"><label>Preco Venda</label><input id="f_preco_venda" type="number" step="0.01" value="0"></div>
                <div class="form-group"><label>Estoque Minimo</label><input id="f_estoque_minimo" type="number" step="0.01" value="0"></div>
                <div class="form-group"><label>Estoque Atual</label><input id="f_estoque_atual" type="number" step="0.01" value="0"></div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="saveProduto()">Salvar</button>
                <button class="btn" onclick="closeModal()">Cancelar</button>
            </div>`
    };
    openModal(forms[type]);
}

async function saveCliente() {
    const body = { nome: f_nome.value, cpf_cnpj: f_cpf_cnpj.value, email: f_email.value, telefone: f_telefone.value, endereco: f_endereco.value, cidade: f_cidade.value, estado: f_estado.value, cep: f_cep.value };
    await apiFetch('/clientes', { method: 'POST', body }); closeModal(); loadClientes();
}

// ---- FORNECEDORES ----
async function loadFornecedores() {
    const data = await apiFetch('/fornecedores');
    document.getElementById('tblFornecedores').innerHTML = data.map(f => `
        <tr><td>${f.id}</td><td>${f.nome}</td><td>${f.cnpj}</td><td>${f.email||'-'}</td><td>${f.telefone||'-'}</td>
        <td>${f.cidade||''}/${f.estado||''}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteItem('/fornecedores/${f.id}','fornecedores')">Excluir</button></td></tr>
    `).join('');
}

async function saveFornecedor() {
    const body = { nome: f_nome.value, cnpj: f_cnpj.value, email: f_email.value, telefone: f_telefone.value, endereco: f_endereco.value, cidade: f_cidade.value, estado: f_estado.value, cep: f_cep.value };
    await apiFetch('/fornecedores', { method: 'POST', body }); closeModal(); loadFornecedores();
}

// ---- PRODUTOS ----
async function loadProdutos() {
    const data = await apiFetch('/produtos');
    document.getElementById('tblProdutos').innerHTML = data.map(p => `
        <tr><td>${p.codigo}</td><td>${p.nome}</td><td>${p.unidade}</td><td>${fmt(p.preco_custo)}</td><td>${fmt(p.preco_venda)}</td><td>${p.estoque_atual}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteItem('/produtos/${p.id}','produtos')">Excluir</button></td></tr>
    `).join('');
}

async function saveProduto() {
    const body = { codigo: f_codigo.value, nome: f_nome.value, descricao: f_descricao.value, unidade: f_unidade.value, preco_custo: parseFloat(f_preco_custo.value), preco_venda: parseFloat(f_preco_venda.value), estoque_minimo: parseFloat(f_estoque_minimo.value), estoque_atual: parseFloat(f_estoque_atual.value) };
    await apiFetch('/produtos', { method: 'POST', body }); closeModal(); loadProdutos();
}

// ---- ORCAMENTOS ----
async function loadOrcamentos() {
    const data = await apiFetch('/orcamentos');
    document.getElementById('tblOrcamentos').innerHTML = data.map(o => `
        <tr><td>${o.numero}</td><td>${o.cliente_nome||'-'}</td><td>${fmtDate(o.data_orcamento)}</td><td>${fmt(o.valor_total)}</td>
        <td><span class="badge ${o.status==='APROVADO'?'badge-ok':o.status==='REJEITADO'?'badge-danger':'badge-warn'}">${o.status}</span></td>
        <td>
            <button class="btn btn-success btn-sm" onclick="updateStatus('/orcamentos/${o.id}','APROVADO','orcamentos')">Aprovar</button>
            <button class="btn btn-danger btn-sm" onclick="deleteItem('/orcamentos/${o.id}','orcamentos')">Excluir</button>
        </td></tr>
    `).join('');
}

let orcItens = [];
async function openOrcamentoForm() {
    orcItens = [];
    const clientes = await apiFetch('/clientes');
    const produtos = await apiFetch('/produtos');
    window._produtos = produtos;
    openModal(`<h3>Novo Orcamento</h3>
        <div class="form-grid">
            <div class="form-group"><label>Numero *</label><input id="f_numero"></div>
            <div class="form-group"><label>Cliente *</label><select id="f_cliente_id">${clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('')}</select></div>
            <div class="form-group"><label>Validade</label><input id="f_data_validade" type="date"></div>
            <div class="form-group"><label>Observacoes</label><input id="f_obs"></div>
        </div>
        <h4>Itens</h4>
        <div id="itensContainer"></div>
        <button class="btn btn-sm" onclick="addItemRow('orc')" style="margin:10px 0">+ Adicionar Item</button>
        <div class="actions"><button class="btn btn-primary" onclick="saveOrcamento()">Salvar</button><button class="btn" onclick="closeModal()">Cancelar</button></div>`);
    addItemRow('orc');
}

function addItemRow(prefix) {
    const prods = window._produtos || [];
    const container = document.getElementById('itensContainer');
    const idx = container.children.length;
    const div = document.createElement('div');
    div.className = 'item-row';
    div.innerHTML = `<select id="${prefix}_prod_${idx}">${prods.map(p=>`<option value="${p.id}" data-preco="${p.preco_venda}">${p.nome}</option>`).join('')}</select>
        <input id="${prefix}_qtd_${idx}" type="number" placeholder="Qtd" min="1" value="1">
        <input id="${prefix}_preco_${idx}" type="number" step="0.01" placeholder="Preco" value="${prods[0]?.preco_venda||0}">
        <span id="${prefix}_sub_${idx}">R$ 0,00</span>
        <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>`;
    container.appendChild(div);
    document.getElementById(`${prefix}_prod_${idx}`).onchange = function() {
        const sel = this.options[this.selectedIndex];
        document.getElementById(`${prefix}_preco_${idx}`).value = sel.dataset.preco;
    };
}

function collectItems(prefix) {
    const container = document.getElementById('itensContainer');
    const items = [];
    for (let i = 0; i < container.children.length; i++) {
        const prod = document.getElementById(`${prefix}_prod_${i}`);
        const qtd = document.getElementById(`${prefix}_qtd_${i}`);
        const preco = document.getElementById(`${prefix}_preco_${i}`);
        if (prod && qtd && preco) items.push({ produto_id: parseInt(prod.value), quantidade: parseFloat(qtd.value), preco_unitario: parseFloat(preco.value) });
    }
    return items;
}

async function saveOrcamento() {
    const body = { numero: f_numero.value, cliente_id: parseInt(f_cliente_id.value), data_validade: f_data_validade.value || null, observacoes: f_obs.value, itens: collectItems('orc') };
    await apiFetch('/orcamentos', { method: 'POST', body }); closeModal(); loadOrcamentos();
}

// ---- PEDIDOS VENDA ----
async function loadPedidos() {
    const data = await apiFetch('/pedidos-venda');
    document.getElementById('tblPedidos').innerHTML = data.map(p => `
        <tr><td>${p.numero}</td><td>${p.cliente_nome||'-'}</td><td>${fmtDate(p.data_pedido)}</td><td>${fmt(p.valor_total)}</td>
        <td><span class="badge ${p.status==='FATURADO'?'badge-ok':p.status==='CANCELADO'?'badge-danger':'badge-info'}">${p.status}</span></td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteItem('/pedidos-venda/${p.id}','pedidos')">Excluir</button></td></tr>
    `).join('');
}

async function openPedidoForm() {
    const clientes = await apiFetch('/clientes');
    const produtos = await apiFetch('/produtos');
    window._produtos = produtos;
    openModal(`<h3>Novo Pedido de Venda</h3>
        <div class="form-grid">
            <div class="form-group"><label>Numero *</label><input id="f_numero"></div>
            <div class="form-group"><label>Cliente *</label><select id="f_cliente_id">${clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('')}</select></div>
            <div class="form-group"><label>Entrega</label><input id="f_data_entrega" type="date"></div>
            <div class="form-group"><label>Observacoes</label><input id="f_obs"></div>
        </div>
        <h4>Itens</h4><div id="itensContainer"></div>
        <button class="btn btn-sm" onclick="addItemRow('ped')" style="margin:10px 0">+ Adicionar Item</button>
        <div class="actions"><button class="btn btn-primary" onclick="savePedido()">Salvar</button><button class="btn" onclick="closeModal()">Cancelar</button></div>`);
    addItemRow('ped');
}

async function savePedido() {
    const body = { numero: f_numero.value, cliente_id: parseInt(f_cliente_id.value), data_entrega: f_data_entrega.value || null, observacoes: f_obs.value, itens: collectItems('ped') };
    await apiFetch('/pedidos-venda', { method: 'POST', body }); closeModal(); loadPedidos();
}

// ---- NOTAS ENTRADA ----
async function loadNotasEntrada() {
    const data = await apiFetch('/notas-entrada');
    document.getElementById('tblNotasEntrada').innerHTML = data.map(n => `
        <tr><td>${n.numero}</td><td>${n.fornecedor_nome||'-'}</td><td>${fmtDate(n.data_entrada)}</td><td>${fmt(n.valor_total)}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteItem('/notas-entrada/${n.id}','notas-entrada')">Excluir</button></td></tr>
    `).join('');
}

async function openNotaEntradaForm() {
    const fornecedores = await apiFetch('/fornecedores');
    const produtos = await apiFetch('/produtos');
    window._produtos = produtos;
    openModal(`<h3>Nova Nota de Entrada</h3>
        <div class="form-grid">
            <div class="form-group"><label>Numero *</label><input id="f_numero"></div>
            <div class="form-group"><label>Fornecedor *</label><select id="f_fornecedor_id">${fornecedores.map(f=>`<option value="${f.id}">${f.nome}</option>`).join('')}</select></div>
            <div class="form-group"><label>Observacoes</label><input id="f_obs"></div>
        </div>
        <h4>Itens</h4><div id="itensContainer"></div>
        <button class="btn btn-sm" onclick="addItemRow('ne')" style="margin:10px 0">+ Adicionar Item</button>
        <div class="actions"><button class="btn btn-primary" onclick="saveNotaEntrada()">Salvar</button><button class="btn" onclick="closeModal()">Cancelar</button></div>`);
    addItemRow('ne');
}

async function saveNotaEntrada() {
    const body = { numero: f_numero.value, fornecedor_id: parseInt(f_fornecedor_id.value), observacoes: f_obs.value, itens: collectItems('ne') };
    await apiFetch('/notas-entrada', { method: 'POST', body }); closeModal(); loadNotasEntrada();
}

// ---- NOTAS SAIDA ----
async function loadNotasSaida() {
    const data = await apiFetch('/notas-saida');
    document.getElementById('tblNotasSaida').innerHTML = data.map(n => `
        <tr><td>${n.numero}</td><td>${n.cliente_nome||'-'}</td><td>${fmtDate(n.data_saida)}</td><td>${fmt(n.valor_total)}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteItem('/notas-saida/${n.id}','notas-saida')">Excluir</button></td></tr>
    `).join('');
}

async function openNotaSaidaForm() {
    const clientes = await apiFetch('/clientes');
    const produtos = await apiFetch('/produtos');
    window._produtos = produtos;
    openModal(`<h3>Nova Nota de Saida</h3>
        <div class="form-grid">
            <div class="form-group"><label>Numero *</label><input id="f_numero"></div>
            <div class="form-group"><label>Cliente *</label><select id="f_cliente_id">${clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('')}</select></div>
            <div class="form-group"><label>Observacoes</label><input id="f_obs"></div>
        </div>
        <h4>Itens</h4><div id="itensContainer"></div>
        <button class="btn btn-sm" onclick="addItemRow('ns')" style="margin:10px 0">+ Adicionar Item</button>
        <div class="actions"><button class="btn btn-primary" onclick="saveNotaSaida()">Salvar</button><button class="btn" onclick="closeModal()">Cancelar</button></div>`);
    addItemRow('ns');
}

async function saveNotaSaida() {
    const body = { numero: f_numero.value, cliente_id: parseInt(f_cliente_id.value), observacoes: f_obs.value, itens: collectItems('ns') };
    await apiFetch('/notas-saida', { method: 'POST', body }); closeModal(); loadNotasSaida();
}

// ---- ESTOQUE ----
async function loadEstoque() {
    const [estoque, movimentos] = await Promise.all([apiFetch('/estoque'), apiFetch('/estoque/movimentos')]);
    document.getElementById('tblEstoque').innerHTML = estoque.map(e => `
        <tr><td>${e.codigo}</td><td>${e.nome}</td><td>${e.unidade}</td><td>${e.estoque_atual}</td><td>${e.estoque_minimo}</td>
        <td><span class="badge ${e.status==='OK'?'badge-ok':'badge-danger'}">${e.status}</span></td></tr>
    `).join('');
    document.getElementById('tblMovimentos').innerHTML = movimentos.map(m => `
        <tr><td>${fmtDate(m.data_movimento)}</td><td>${m.produto_nome||'-'}</td>
        <td><span class="badge ${m.tipo==='ENTRADA'?'badge-ok':m.tipo==='SAIDA'?'badge-danger':'badge-warn'}">${m.tipo}</span></td>
        <td>${m.quantidade}</td><td>${m.estoque_anterior}</td><td>${m.estoque_atual}</td><td>${m.referencia||'-'}</td></tr>
    `).join('');
}

// ---- FINANCEIRO ----
async function loadFinanceiro() {
    const [resumo, lancamentos] = await Promise.all([apiFetch('/financeiro/resumo'), apiFetch('/financeiro/lancamentos')]);
    document.getElementById('finCards').innerHTML = `
        <div class="card card-green"><h3>${fmt(resumo.receitas.total)}</h3><p>Receitas</p></div>
        <div class="card card-red"><h3>${fmt(resumo.despesas.total)}</h3><p>Despesas</p></div>
        <div class="card card-blue"><h3>${fmt(resumo.saldo)}</h3><p>Saldo Atual</p></div>
        <div class="card card-yellow"><h3>${fmt(resumo.saldo_previsto)}</h3><p>Saldo Previsto</p></div>
    `;
    document.getElementById('tblFinanceiro').innerHTML = lancamentos.map(l => `
        <tr><td>${l.id}</td><td><span class="badge ${l.tipo==='RECEITA'?'badge-ok':'badge-danger'}">${l.tipo}</span></td>
        <td>${l.descricao}</td><td>${fmt(l.valor)}</td><td>${fmtDate(l.data_vencimento)}</td>
        <td><span class="badge ${l.status==='PAGO'?'badge-ok':l.status==='CANCELADO'?'badge-danger':'badge-warn'}">${l.status}</span></td>
        <td>${l.status==='PENDENTE'?`<button class="btn btn-success btn-sm" onclick="pagarLancamento(${l.id})">Pagar</button>`:''}</td></tr>
    `).join('');
}

function openLancamentoForm() {
    openModal(`<h3>Novo Lancamento Financeiro</h3>
        <div class="form-grid">
            <div class="form-group"><label>Tipo *</label><select id="f_tipo"><option value="RECEITA">Receita</option><option value="DESPESA">Despesa</option></select></div>
            <div class="form-group"><label>Descricao *</label><input id="f_descricao"></div>
            <div class="form-group"><label>Valor *</label><input id="f_valor" type="number" step="0.01"></div>
            <div class="form-group"><label>Vencimento</label><input id="f_data_vencimento" type="date"></div>
            <div class="form-group"><label>Categoria</label><input id="f_categoria"></div>
            <div class="form-group"><label>Observacoes</label><input id="f_obs"></div>
        </div>
        <div class="actions"><button class="btn btn-primary" onclick="saveLancamento()">Salvar</button><button class="btn" onclick="closeModal()">Cancelar</button></div>`);
}

async function saveLancamento() {
    const body = { tipo: f_tipo.value, descricao: f_descricao.value, valor: parseFloat(f_valor.value), data_vencimento: f_data_vencimento.value || null, categoria: f_categoria.value, observacoes: f_obs.value };
    await apiFetch('/financeiro/lancamentos', { method: 'POST', body }); closeModal(); loadFinanceiro();
}

async function pagarLancamento(id) {
    await apiFetch(`/financeiro/lancamentos/${id}`, { method: 'PUT', body: { status: 'PAGO' } }); loadFinanceiro();
}

// ---- GENERICOS ----
async function deleteItem(endpoint, panel) {
    if (!confirm('Confirma a exclusao?')) return;
    await apiFetch(endpoint, { method: 'DELETE' }); loadPanelData(panel);
}

async function updateStatus(endpoint, status, panel) {
    await apiFetch(endpoint, { method: 'PUT', body: { status } }); loadPanelData(panel);
}

// Init
loadDashboard();
</script>
</body>
</html>
